<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Swapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">
    <div class="container bg-gray-800 p-8 rounded-lg shadow-lg max-w-lg w-full">
        <h1 class="text-3xl font-bold text-purple-400 mb-6 text-center">Face Swapper</h1>
        <form id="face-swap-form" method="POST" action="/process" enctype="multipart/form-data" class="space-y-4">
            <div>
                <label for="source_file" class="block text-sm font-medium text-purple-400">Source File:</label>
                <input type="file" id="source_file" name="source_file" required class="mt-1 block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label for="target_files" class="block text-sm font-medium text-purple-400">Target Files:</label>
                <input type="file" id="target_files" name="target_files" multiple required class="mt-1 block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label for="output_dir" class="block text-sm font-medium text-purple-400">Output Directory:</label>
                <div class="flex items-center mt-1">
                    <input type="text" id="output_dir" name="output_dir" value="Output" readonly required class="block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button type="button" onclick="selectDirectory()" class="ml-2 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500">Browse</button>
                </div>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="face_enhancer" name="face_enhancer" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                <label for="face_enhancer" class="ml-2 block text-sm font-medium text-purple-400">Use Face Enhancer</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="keep_fps" name="keep_fps" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                <label for="keep_fps" class="ml-2 block text-sm font-medium text-purple-400">Keep FPS</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="keep_audio" name="keep_audio" checked class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                <label for="keep_audio" class="ml-2 block text-sm font-medium text-purple-400">Keep Audio</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="keep_frames" name="keep_frames" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                <label for="keep_frames" class="ml-2 block text-sm font-medium text-purple-400">Keep Frames</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="many_faces" name="many_faces" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                <label for="many_faces" class="ml-2 block text-sm font-medium text-purple-400">Process Every Face</label>
            </div>
            <div>
                <label for="max_memory" class="block text-sm font-medium text-purple-400">Max Memory (GB):</label>
                <input type="number" id="max_memory" name="max_memory" value="16" class="mt-1 block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label for="execution_provider" class="block text-sm font-medium text-purple-400">Execution Provider:</label>
                <select id="execution_provider" name="execution_provider" multiple class="mt-1 block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="cpu">CPU</option>
                    <option value="cuda" selected>CUDA</option>
                    <option value="rocm">ROCM</option>
                    <option value="coreml">CoreML</option>
                </select>
            </div>
            <div>
                <label for="execution_threads" class="block text-sm font-medium text-purple-400">Execution Threads:</label>
                <input type="number" id="execution_threads" name="execution_threads" value="8" class="mt-1 block w-full text-sm text-gray-900 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <button type="submit" class="w-full py-2 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500">Start Processing</button>
        </form>
        <div id="status-container" class="mt-4 max-h-64 overflow-y-auto">
            <p id="status" class="text-green-400"></p>
        </div>
        <div class="mt-4">
            <label for="progress" class="block text-sm font-medium text-purple-400">Progress:</label>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <div id="preview-container" class="mt-4 hidden">
            <h3 class="text-lg font-medium text-purple-400 mb-2">Preview:</h3>
            <div id="preview-content" class="flex flex-wrap justify-center"></div>
        </div>
        <div id="download-container" class="mt-4 hidden">
            <h3 class="text-lg font-medium text-purple-400 mb-2">Download Processed Files:</h3>
            <ul id="download-links" class="list-disc pl-5"></ul>
            <button id="download-all" class="mt-2 py-2 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500">Download All</button>
        </div>
    </div>

    <!-- Modal for enlarged preview -->
    <div id="preview-modal" class="modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="enlarged-preview">
    </div>

    <script>
        async function selectDirectory() {
            try {
                const directoryHandle = await window.showDirectoryPicker();
                document.getElementById('output_dir').value = directoryHandle.name;
                // Store the directory handle for later use
                window.selectedDirectoryHandle = directoryHandle;
            } catch (err) {
                console.error('Error selecting directory:', err);
            }
        }

        document.getElementById('face-swap-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Add the directory handle to the form data
            if (window.selectedDirectoryHandle) {
                formData.append('output_dir', window.selectedDirectoryHandle.name);
            }

            const response = await fetch('/process', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            document.getElementById('status').innerText = result.status;
            startEventSource();
        });

        function startEventSource() {
            const eventSource = new EventSource('/status');
            eventSource.onmessage = function(event) {
                const statusElement = document.getElementById('status');
                const progressBar = document.getElementById('progress-bar');
                const data = JSON.parse(event.data);

                if (data.message) {
                    statusElement.innerHTML += data.message + '<br>';
                }

                if (data.progress) {
                    progressBar.style.width = data.progress + '%';
                }

                if (data.status === 'complete') {
                    displayPreviewAndDownloadLinks(data.output_files);
                    eventSource.close();
                }

                const statusContainer = document.getElementById('status-container');
                statusContainer.scrollTop = statusContainer.scrollHeight; // Auto-scroll to the bottom
            };
        }

        function displayPreviewAndDownloadLinks(outputFiles) {
            const previewContainer = document.getElementById('preview-container');
            const previewContent = document.getElementById('preview-content');
            const downloadContainer = document.getElementById('download-container');
            const downloadLinks = document.getElementById('download-links');
            
            previewContent.innerHTML = '';
            downloadLinks.innerHTML = '';
            
            outputFiles.forEach((file, index) => {
                // Preview
                const previewItem = document.createElement('div');
                previewItem.className = 'w-full sm:w-1/2 md:w-1/3 p-2';
                if (file.toLowerCase().endsWith('.mp4')) {
                    const video = document.createElement('video');
                    video.src = `/preview/${encodeURIComponent(file)}`;
                    video.className = 'w-full h-auto cursor-pointer';
                    video.controls = true;
                    video.addEventListener('click', () => enlargePreview(video.src));
                    previewItem.appendChild(video);
                } else {
                    const img = document.createElement('img');
                    img.src = `/preview/${encodeURIComponent(file)}`;
                    img.className = 'w-full h-auto cursor-pointer';
                    img.addEventListener('click', () => enlargePreview(img.src));
                    previewItem.appendChild(img);
                }
                previewContent.appendChild(previewItem);

                // Download link
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = `/download/${encodeURIComponent(file)}`;
                link.textContent = `Download Output ${index + 1}`;
                link.className = 'text-purple-400 hover:text-purple-300';
                li.appendChild(link);
                downloadLinks.appendChild(li);
            });

            previewContainer.classList.remove('hidden');
            downloadContainer.classList.remove('hidden');

            // Add event listener for "Download All" button
            document.getElementById('download-all').addEventListener('click', () => downloadAll(outputFiles));
        }

        function enlargePreview(src) {
            const modal = document.getElementById('preview-modal');
            const enlargedPreview = document.getElementById('enlarged-preview');
            modal.style.display = 'block';
            enlargedPreview.src = src;
        }

        // Close the modal when clicking on <span> (x)
        document.getElementsByClassName('close')[0].onclick = function() {
            document.getElementById('preview-modal').style.display = 'none';
        }

        // Close the modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('preview-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function downloadAll(outputFiles) {
            for (const file of outputFiles) {
                const link = document.createElement('a');
                link.href = `/download/${encodeURIComponent(file)}`;
                link.download = file.split('/').pop(); // Extract filename from path
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second between downloads
            }
        }
    </script>
</body>
</html>